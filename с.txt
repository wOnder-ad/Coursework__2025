import React, { useState, useMemo, useEffect } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, BarChart, Bar, PieChart, Pie, Cell, AreaChart, Area, ScatterChart, Scatter } from 'recharts';
import { Upload, TrendingUp, Settings, Play, Download, DollarSign, Calendar, PieChart as PieIcon, BarChart3, TrendingDown, AlertCircle, Info, Target, Zap, Save, FolderOpen } from 'lucide-react';

const API_BASE = 'https://api.anthropic.com/v1/messages';

const PortfolioAnalyzer = () => {
  // –°—Ç–∞–Ω –¥–∞–Ω–∏—Ö
  const [stockData, setStockData] = useState(null);
  const [loading, setLoading] = useState(false);
  const [activeTab, setActiveTab] = useState('portfolio');
  
  // –ü–æ—Ä—Ç—Ñ–æ–ª—ñ–æ
  const [selectedStocks, setSelectedStocks] = useState([]);
  const [weights, setWeights] = useState({});
  const [searchTerm, setSearchTerm] = useState('');
  
  // –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ —ñ–Ω–≤–µ—Å—Ç—É–≤–∞–Ω–Ω—è
  const [investmentType, setInvestmentType] = useState('lumpsum'); // lumpsum, monthly, yearly
  const [initialInvestment, setInitialInvestment] = useState(10000);
  const [monthlyContribution, setMonthlyContribution] = useState(500);
  const [yearlyContribution, setYearlyContribution] = useState(6000);
  const [rebalanceFrequency, setRebalanceFrequency] = useState('yearly'); // never, monthly, quarterly, yearly
  
  // –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ —Å–∏–º—É–ª—è—Ü—ñ—ó
  const [forecastYears, setForecastYears] = useState(10);
  const [simulations, setSimulations] = useState(10000);
  const [dateRange, setDateRange] = useState({ start: '2013-02-08', end: '2018-02-07' });
  const [confidenceLevel, setConfidenceLevel] = useState(95);
  const [inflationRate, setInflationRate] = useState(2.5);
  
  // –î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏
  const [taxRate, setTaxRate] = useState(15);
  const [expenseRatio, setExpenseRatio] = useState(0.1);
  const [dividendReinvest, setDividendReinvest] = useState(true);
  
  // –†–µ–∑—É–ª—å—Ç–∞—Ç–∏
  const [results, setResults] = useState(null);
  const [savedPortfolios, setSavedPortfolios] = useState([]);

  // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è CSV –ø—Ä–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
  useEffect(() => {
    loadDefaultData();
    loadSavedPortfolios();
  }, []);

  const loadDefaultData = async () => {
    try {
      setLoading(true);
      const response = await fetch('/all_stocks_5yr.csv');
      if (!response.ok) {
        throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ');
      }
      const text = await response.text();
      parseCSV(text);
    } catch (error) {
      console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:', error);
      alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–∞–π–ª all_stocks_5yr.csv –≤—Ä—É—á–Ω—É');
    } finally {
      setLoading(false);
    }
  };

  const parseCSV = (text) => {
    const lines = text.split('\n').filter(line => line.trim());
    const headers = lines[0].split(',');
    
    const stockMap = {};
    const dateSet = new Set();
    
    for (let i = 1; i < lines.length; i++) {
      const values = lines[i].split(',');
      if (values.length < 7) continue;
      
      const date = values[0];
      const name = values[6];
      const close = parseFloat(values[4]);
      const volume = parseFloat(values[5]);
      
      if (!date || !name || isNaN(close)) continue;
      
      dateSet.add(date);
      
      if (!stockMap[date]) {
        stockMap[date] = { Date: date };
      }
      
      stockMap[date][name] = { close, volume };
    }
    
    const transformedData = Array.from(dateSet)
      .sort()
      .map(date => stockMap[date])
      .filter(row => row && Object.keys(row).length > 1);
    
    setStockData(transformedData);
    
    if (transformedData.length > 0) {
      setDateRange({
        start: transformedData[0].Date,
        end: transformedData[transformedData.length - 1].Date
      });
    }
  };

  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        parseCSV(event.target.result);
      };
      reader.readAsText(file);
    }
  };

  const availableStocks = useMemo(() => {
    if (!stockData || stockData.length === 0) return [];
    const stocks = new Set();
    stockData.forEach(row => {
      Object.keys(row).forEach(key => {
        if (key !== 'Date' && row[key]?.close) {
          stocks.add(key);
        }
      });
    });
    return Array.from(stocks).sort();
  }, [stockData]);

  const handleStockToggle = (stock) => {
    if (selectedStocks.includes(stock)) {
      setSelectedStocks(selectedStocks.filter(s => s !== stock));
      const newWeights = { ...weights };
      delete newWeights[stock];
      setWeights(newWeights);
    } else {
      setSelectedStocks([...selectedStocks, stock]);
      const equalWeight = 1 / (selectedStocks.length + 1);
      const newWeights = {};
      [...selectedStocks, stock].forEach(s => {
        newWeights[s] = equalWeight;
      });
      setWeights(newWeights);
    }
  };

  const handleWeightChange = (stock, value) => {
    setWeights({ ...weights, [stock]: parseFloat(value) || 0 });
  };

  const normalizeWeights = () => {
    const total = Object.values(weights).reduce((a, b) => a + b, 0);
    if (total > 0) {
      const normalized = {};
      Object.keys(weights).forEach(stock => {
        normalized[stock] = weights[stock] / total;
      });
      setWeights(normalized);
    }
  };

  const calculatePortfolioMetrics = (data, stocks, weights) => {
    const returns = [];
    const portfolioValues = [];
    
    for (let i = 1; i < data.length; i++) {
      let portfolioReturn = 0;
      let valid = true;
      
      stocks.forEach(stock => {
        const prev = data[i - 1][stock]?.close;
        const curr = data[i][stock]?.close;
        
        if (!prev || !curr || prev === 0) {
          valid = false;
          return;
        }
        
        const stockReturn = (curr - prev) / prev;
        portfolioReturn += weights[stock] * stockReturn;
      });
      
      if (valid) {
        returns.push(portfolioReturn);
      }
    }
    
    // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫
    const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
    const variance = returns.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / returns.length;
    const stdDev = Math.sqrt(variance);
    
    const tradingDays = 252;
    const annualReturn = mean * tradingDays;
    const annualVolatility = stdDev * Math.sqrt(tradingDays);
    const sharpeRatio = annualReturn / annualVolatility;
    
    // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –ø—Ä–æ—Å–∞–¥–∫–∞
    let peak = initialInvestment;
    let maxDrawdown = 0;
    let currentValue = initialInvestment;
    
    returns.forEach(ret => {
      currentValue *= (1 + ret);
      if (currentValue > peak) peak = currentValue;
      const drawdown = (peak - currentValue) / peak;
      if (drawdown > maxDrawdown) maxDrawdown = drawdown;
    });
    
    // Value at Risk (VaR)
    const sortedReturns = [...returns].sort((a, b) => a - b);
    const varIndex = Math.floor(returns.length * 0.05);
    const var95 = sortedReturns[varIndex];
    
    return {
      annualReturn,
      annualVolatility,
      sharpeRatio,
      maxDrawdown,
      var95: var95 * Math.sqrt(tradingDays),
      meanReturn: mean,
      stdDev: stdDev
    };
  };

  const runMonteCarloSimulation = () => {
    setLoading(true);
    
    setTimeout(() => {
      try {
        const filteredData = stockData.filter(row => {
          const date = row.Date;
          return date >= dateRange.start && date <= dateRange.end;
        });

        const historicalMetrics = calculatePortfolioMetrics(filteredData, selectedStocks, weights);
        
        const tradingDays = 252;
        const totalDays = forecastYears * tradingDays;
        const monthsInYear = 12;
        
        const simulationPaths = [];
        const finalValues = [];
        const yearlyReturns = [];

        for (let sim = 0; sim < simulations; sim++) {
          let portfolioValue = initialInvestment;
          const path = [{ year: 0, value: portfolioValue, contributions: initialInvestment }];
          let totalContributions = initialInvestment;
          
          for (let year = 1; year <= forecastYears; year++) {
            let yearReturn = 0;
            
            // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Ä—ñ—á–Ω–æ–≥–æ –¥–æ—Ö–æ–¥—É –∑ –Ω–æ—Ä–º–∞–ª—å–Ω–∏–º —Ä–æ–∑–ø–æ–¥—ñ–ª–æ–º
            const random = (Math.random() + Math.random() + Math.random() + Math.random() + 
                          Math.random() + Math.random() + Math.random() + Math.random() + 
                          Math.random() + Math.random() + Math.random() + Math.random()) / 12 - 0.5;
            const normalRandom = random * 2.5;
            
            yearReturn = historicalMetrics.annualReturn + historicalMetrics.annualVolatility * normalRandom;
            
            // –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è —ñ–Ω—Ñ–ª—è—Ü—ñ—ó —Ç–∞ –≤–∏—Ç—Ä–∞—Ç
            const realReturn = yearReturn - (inflationRate / 100) - (expenseRatio / 100);
            
            portfolioValue *= (1 + realReturn);
            
            // –î–æ–¥–∞–≤–∞–Ω–Ω—è –≤–Ω–µ—Å–∫—ñ–≤
            if (investmentType === 'monthly') {
              const monthlyValue = monthlyContribution * monthsInYear;
              portfolioValue += monthlyValue * (1 + realReturn / 2); // –°–µ—Ä–µ–¥–Ω—ñ–π –µ—Ñ–µ–∫—Ç –≤–Ω–µ—Å–∫—ñ–≤
              totalContributions += monthlyValue;
            } else if (investmentType === 'yearly') {
              portfolioValue += yearlyContribution * (1 + realReturn / 2);
              totalContributions += yearlyContribution;
            }
            
            path.push({ 
              year, 
              value: portfolioValue,
              contributions: totalContributions,
              gains: portfolioValue - totalContributions
            });
            
            if (year === forecastYears) {
              yearlyReturns.push(yearReturn);
            }
          }

          simulationPaths.push(path);
          finalValues.push(portfolioValue);
        }

        finalValues.sort((a, b) => a - b);
        yearlyReturns.sort((a, b) => a - b);
        
        const percentile = (arr, p) => arr[Math.floor(arr.length * p)];

        const avgPath = [];
        for (let year = 0; year <= forecastYears; year++) {
          const values = simulationPaths.map(sim => sim[year].value);
          const contributions = simulationPaths.map(sim => sim[year].contributions);
          const gains = simulationPaths.map(sim => sim[year].gains);
          
          values.sort((a, b) => a - b);
          
          avgPath.push({
            year,
            average: values.reduce((a, b) => a + b, 0) / values.length,
            median: percentile(values, 0.5),
            p10: percentile(values, 0.1),
            p25: percentile(values, 0.25),
            p75: percentile(values, 0.75),
            p90: percentile(values, 0.9),
            contributions: contributions[0],
            gains: gains.reduce((a, b) => a + b, 0) / gains.length
          });
        }

        // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –π–º–æ–≤—ñ—Ä–Ω–æ—Å—Ç—ñ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è —Ü—ñ–ª—ñ
        const targetValue = initialInvestment * 2; // –ü–æ–¥–≤–æ—î–Ω–Ω—è
        const successRate = finalValues.filter(v => v >= targetValue).length / simulations;

        // –ê–Ω–∞–ª—ñ–∑ —Ä—ñ—á–Ω–∏—Ö –¥–æ—Ö–æ–¥—ñ–≤
        const avgAnnualReturn = yearlyReturns.reduce((a, b) => a + b, 0) / yearlyReturns.length;
        const positiveYears = yearlyReturns.filter(r => r > 0).length / yearlyReturns.length;

        setResults({
          avgPath,
          finalValues,
          historicalMetrics,
          simulationStats: {
            median: percentile(finalValues, 0.5),
            p10: percentile(finalValues, 0.1),
            p25: percentile(finalValues, 0.25),
            p75: percentile(finalValues, 0.75),
            p90: percentile(finalValues, 0.9),
            best: finalValues[finalValues.length - 1],
            worst: finalValues[0],
            average: finalValues.reduce((a, b) => a + b, 0) / finalValues.length,
            successRate,
            avgAnnualReturn,
            positiveYears
          }
        });

      } catch (error) {
        alert('–ü–æ–º–∏–ª–∫–∞ —Å–∏–º—É–ª—è—Ü—ñ—ó: ' + error.message);
        console.error(error);
      }
      
      setLoading(false);
    }, 100);
  };

  const savePortfolio = async () => {
    const portfolio = {
      name: `–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ ${new Date().toLocaleDateString('uk-UA')}`,
      stocks: selectedStocks,
      weights,
      settings: {
        investmentType,
        initialInvestment,
        monthlyContribution,
        yearlyContribution,
        forecastYears,
        rebalanceFrequency
      },
      timestamp: Date.now()
    };
    
    try {
      const stored = await window.storage.get('portfolios');
      const portfolios = stored ? JSON.parse(stored.value) : [];
      portfolios.push(portfolio);
      await window.storage.set('portfolios', JSON.stringify(portfolios));
      setSavedPortfolios(portfolios);
      alert('–ü–æ—Ä—Ç—Ñ–æ–ª—ñ–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
    } catch (error) {
      console.error('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è:', error);
    }
  };

  const loadSavedPortfolios = async () => {
    try {
      const stored = await window.storage.get('portfolios');
      if (stored) {
        setSavedPortfolios(JSON.parse(stored.value));
      }
    } catch (error) {
      console.log('–ù–µ–º–∞—î –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö –ø–æ—Ä—Ç—Ñ–æ–ª—ñ–æ');
    }
  };

  const loadPortfolio = (portfolio) => {
    setSelectedStocks(portfolio.stocks);
    setWeights(portfolio.weights);
    setInvestmentType(portfolio.settings.investmentType);
    setInitialInvestment(portfolio.settings.initialInvestment);
    setMonthlyContribution(portfolio.settings.monthlyContribution);
    setYearlyContribution(portfolio.settings.yearlyContribution);
    setForecastYears(portfolio.settings.forecastYears);
    setRebalanceFrequency(portfolio.settings.rebalanceFrequency);
    setActiveTab('portfolio');
  };

  const totalWeight = Object.values(weights).reduce((a, b) => a + b, 0);
  const isWeightValid = Math.abs(totalWeight - 1) < 0.01;

  const COLORS = ['#8b5cf6', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#ec4899', '#14b8a6', '#f97316'];

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white p-4">
      <div className="max-w-7xl mx-auto">
        {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
        <header className="text-center mb-8">
          <h1 className="text-5xl font-bold mb-3 bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">
            –ü—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π –ê–Ω–∞–ª—ñ–∑–∞—Ç–æ—Ä –Ü–Ω–≤–µ—Å—Ç–∏—Ü—ñ–π
          </h1>
          <p className="text-gray-300 text-lg">S&P 500 ‚Ä¢ –°–∏–º—É–ª—è—Ü—ñ—è –ú–æ–Ω—Ç–µ-–ö–∞—Ä–ª–æ ‚Ä¢ –ì–ª–∏–±–æ–∫–∞ –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞</p>
        </header>

        {/* –ù–∞–≤—ñ–≥–∞—Ü—ñ—è */}
        <div className="flex gap-2 mb-6 flex-wrap">
          {[
            { id: 'portfolio', label: '–ü–æ—Ä—Ç—Ñ–æ–ª—ñ–æ', icon: PieIcon },
            { id: 'settings', label: '–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è', icon: Settings },
            { id: 'analysis', label: '–ê–Ω–∞–ª—ñ–∑', icon: BarChart3 },
            { id: 'saved', label: '–ó–±–µ—Ä–µ–∂–µ–Ω—ñ', icon: FolderOpen }
          ].map(tab => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all ${
                activeTab === tab.id
                  ? 'bg-gradient-to-r from-purple-600 to-blue-600'
                  : 'bg-white/10 hover:bg-white/20'
              }`}
            >
              <tab.icon size={20} />
              {tab.label}
            </button>
          ))}
        </div>

        {/* –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö */}
        {!stockData && (
          <div className="bg-white/10 backdrop-blur-lg rounded-xl p-8 border border-white/20 mb-6 text-center">
            <Upload size={48} className="mx-auto mb-4 text-purple-400" />
            <h2 className="text-2xl font-bold mb-4">–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –¥–∞–Ω—ñ S&P 500</h2>
            <input
              type="file"
              accept=".csv"
              onChange={handleFileUpload}
              className="inline-block text-sm text-gray-300 file:mr-4 file:py-3 file:px-6 file:rounded-full file:border-0 file:bg-purple-600 file:text-white hover:file:bg-purple-700 cursor-pointer"
            />
            <p className="text-sm text-gray-400 mt-4">
              –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–∞–π–ª all_stocks_5yr.csv –∑ Kaggle
            </p>
          </div>
        )}

        {/* –ü–æ—Ä—Ç—Ñ–æ–ª—ñ–æ */}
        {activeTab === 'portfolio' && stockData && (
          <div className="space-y-6">
            <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
              <h2 className="text-2xl font-semibold mb-4">–í–∏–±–µ—Ä—ñ—Ç—å –∞–∫—Ü—ñ—ó –¥–ª—è –ø–æ—Ä—Ç—Ñ–µ–ª—é</h2>
              
              <div className="mb-4">
                <input
                  type="text"
                  placeholder="üîç –ü–æ—à—É–∫ —Ç—ñ–∫–µ—Ä–∞ (AAPL, GOOGL, MSFT...)"
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="w-full bg-white/5 border border-white/20 rounded-lg px-4 py-3 text-white placeholder-gray-400"
                />
              </div>

              <div className="grid grid-cols-4 md:grid-cols-8 lg:grid-cols-10 gap-2 mb-4 max-h-80 overflow-y-auto p-2">
                {availableStocks
                  .filter(stock => stock.toUpperCase().includes(searchTerm.toUpperCase()))
                  .map(stock => (
                    <button
                      key={stock}
                      onClick={() => handleStockToggle(stock)}
                      className={`p-3 rounded-lg border-2 transition-all text-xs font-mono font-bold ${
                        selectedStocks.includes(stock)
                          ? 'bg-gradient-to-r from-purple-600 to-blue-600 border-purple-400 scale-105'
                          : 'bg-white/5 border-white/20 hover:border-white/40 hover:scale-105'
                      }`}
                    >
                      {stock}
                    </button>
                  ))}
              </div>

              {selectedStocks.length > 0 && (
                <div className="mt-6 space-y-4">
                  <div className="flex justify-between items-center">
                    <h3 className="text-xl font-semibold">
                      –†–æ–∑–ø–æ–¥—ñ–ª —ñ–Ω–≤–µ—Å—Ç–∏—Ü—ñ–π ({(totalWeight * 100).toFixed(1)}%)
                    </h3>
                    <div className="flex gap-2">
                      <button
                        onClick={normalizeWeights}
                        className="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm"
                      >
                        –ù–æ—Ä–º–∞–ª—ñ–∑—É–≤–∞—Ç–∏
                      </button>
                      {!isWeightValid && (
                        <span className="text-red-400 text-sm flex items-center gap-1">
                          <AlertCircle size={16} />
                          –°—É–º–∞ ‚â† 100%
                        </span>
                      )}
                    </div>
                  </div>

                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    {selectedStocks.map((stock, idx) => (
                      <div key={stock} className="bg-white/5 p-4 rounded-lg border border-white/10">
                        <div className="flex items-center gap-2 mb-2">
                          <div 
                            className="w-3 h-3 rounded-full" 
                            style={{ backgroundColor: COLORS[idx % COLORS.length] }}
                          />
                          <label className="text-sm font-bold font-mono">{stock}</label>
                        </div>
                        <input
                          type="number"
                          step="0.01"
                          min="0"
                          max="1"
                          value={weights[stock] || 0}
                          onChange={(e) => handleWeightChange(stock, e.target.value)}
                          className="w-full bg-white/10 border border-white/20 rounded px-3 py-2 text-white mb-1"
                        />
                        <div className="text-center">
                          <span className="text-lg font-bold text-purple-400">
                            {((weights[stock] || 0) * 100).toFixed(1)}%
                          </span>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          </div>
        )}

        {/* –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è */}
        {activeTab === 'settings' && (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* –¢–∏–ø —ñ–Ω–≤–µ—Å—Ç—É–≤–∞–Ω–Ω—è */}
            <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
              <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
                <DollarSign size={20} />
                –°—Ç—Ä–∞—Ç–µ–≥—ñ—è —ñ–Ω–≤–µ—Å—Ç—É–≤–∞–Ω–Ω—è
              </h2>
              
              <div className="space-y-4">
                <div>
                  <label className="text-sm text-gray-300 mb-2 block">–¢–∏–ø —ñ–Ω–≤–µ—Å—Ç—É–≤–∞–Ω–Ω—è</label>
                  <select
                    value={investmentType}
                    onChange={(e) => setInvestmentType(e.target.value)}
                    className="w-full bg-white/5 border border-white/20 rounded-lg px-4 py-3 text-white"
                  >
                    <option value="lumpsum">–û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞ —ñ–Ω–≤–µ—Å—Ç–∏—Ü—ñ—è</option>
                    <option value="monthly">–©–æ–º—ñ—Å—è—á–Ω—ñ –≤–Ω–µ—Å–∫–∏</option>
                    <option value="yearly">–©–æ—Ä—ñ—á–Ω—ñ –≤–Ω–µ—Å–∫–∏</option>
                  </select>
                </div>

                <div>
                  <label className="text-sm text-gray-300 mb-2 block">–ü–æ—á–∞—Ç–∫–æ–≤–∞ —ñ–Ω–≤–µ—Å—Ç–∏—Ü—ñ—è ($)</label>
                  <input
                    type="number"
                    value={initialInvestment}
                    onChange={(e) => setInitialInvestment(Number(e.target.value))}
                    className="w-full bg-white/5 border border-white/20 rounded-lg px-4 py-3 text-white"
                  />
                </div>

                {investmentType === 'monthly' && (
                  <div>
                    <label className="text-sm text-gray-300 mb-2 block">–©–æ–º—ñ—Å—è—á–Ω–∏–π –≤–Ω–µ—Å–æ–∫ ($)</label>
                    <input
                      type="number"
                      value={monthlyContribution}
                      onChange={(e) => setMonthlyContribution(Number(e.target.value))}
                      className="w-full bg-white/5 border border-white/20 rounded-lg px-4 py-3 text-white"
                    />
                    <p className="text-xs text-gray-400 mt-1">
                      –†—ñ—á–Ω–∏–π –≤–Ω–µ—Å–æ–∫: ${(monthlyContribution * 12).toLocaleString()}
                    </p>
                  </div>
                )}

                {investmentType === 'yearly' && (
                  <div>
                    <label className="text-sm text-gray-300 mb-2 block">–©–æ—Ä—ñ—á–Ω–∏–π –≤–Ω–µ—Å–æ–∫ ($)</label>
                    <input
                      type="number"
                      value={yearlyContribution}
                      onChange={(e) => setYearlyContribution(Number(e.target.value))}
                      className="w-full bg-white/5 border border-white/20 rounded-lg px-4 py-3 text-white"
                    />
                  </div>
                )}

                <div>
                  <label className="text-sm text-gray-300 mb-2 block">–†–µ–±–∞–ª–∞–Ω—Å—É–≤–∞–Ω–Ω—è –ø–æ—Ä—Ç—Ñ–µ–ª—é</label>
                  <select
                    value={rebalanceFrequency}
                    onChange={(e) => setRebalanceFrequency(e.target.value)}
                    className="w-full bg-white/5 border border-white/20 rounded-lg px-4 py-3 text-white"
                  >
                    <option value="never">–ù—ñ–∫–æ–ª–∏</option>
                    <option value="monthly">–©–æ–º—ñ—Å—è—Ü—è</option>
                    <option value="quarterly">–©–æ–∫–≤–∞—Ä—Ç–∞–ª—É</option>
                    <option value="yearly">–©–æ—Ä–æ–∫—É</option>
                  </select>
                </div>
              </div>
            </div>

            {/* –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ —Å–∏–º—É–ª—è—Ü—ñ—ó */}
            <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
              <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
                <Settings size={20} />
                –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ —Å–∏–º—É–ª—è—Ü—ñ—ó
              </h2>
              
              <div className="space-y-4">
                <div>
                  <label className="text-sm text-gray-300 mb-2 block">–ì–æ—Ä–∏–∑–æ–Ω—Ç –ø—Ä–æ–≥–Ω–æ–∑—É (—Ä–æ–∫—ñ–≤)</label>
                  <input
                    type="number"
                    value={forecastYears}
                    onChange={(e) => setForecastYears(Number(e.target.value))}
                    className="w-full bg-white/5 border border-white/20 rounded-lg px-4 py-3 text-white"
                  />
                </div>

                <div>
                  <label className="text-sm text-gray-300 mb-2 block">
                    –ö—ñ–ª—å–∫—ñ—Å—Ç—å —Å–∏–º—É–ª—è—Ü—ñ–π (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ 10,000+)
                  </label>
                  <input
                    type="number"
                    value={simulations}
                    onChange={(e) => setSimulations(Number(e.target.value))}
                    className="w-full bg-white/5 border border-white/20 rounded-lg px-4 py-3 text-white"
                  />
                </div>

                <div>
                  <label className="text-sm text-gray-300 mb-2 block">–†—ñ–≤–µ–Ω—å –¥–æ–≤—ñ—Ä–∏ (%)</label>
                  <input
                    type="number"
                    value={confidenceLevel}
                    onChange={(e) => setConfidenceLevel(Number(e.target.value))}
                    className="w-full bg-white/5 border border-white/20 rounded-lg px-4 py-3 text-white"
                  />
                </div>

                <div>
                  <label className="text-sm text-gray-300 mb-2 block">–Ü–Ω—Ñ–ª—è—Ü—ñ—è (% –Ω–∞ —Ä—ñ–∫)</label>
                  <input
                    type="number"
                    step="0.1"
                    value={inflationRate}
                    onChange={(e) => setInflationRate(Number(e.target.value))}
                    className="w-full bg-white/5 border border-white/20 rounded-lg px-4 py-3 text-white"
                  />
                </div>

                <div>
                  <label className="text-sm text-gray-300 mb-2 block">–ö–æ–º—ñ—Å—ñ—è –±—Ä–æ–∫–µ—Ä–∞ (% –Ω–∞ —Ä—ñ–∫)</label>
                  <input
                    type="number"
                    step="0.01"
                    value={expenseRatio}
                    onChange={(e) => setExpenseRatio(Number(e.target.value))}
                    className="w-full bg-white/5 border border-white/20 rounded-lg px-4 py-3 text-white"
                  />
                </div>

                <div>
                  <label className="text-sm text-gray-300 mb-2 block">–ü–æ–¥–∞—Ç–æ–∫ –Ω–∞ –ø—Ä–∏–±—É—Ç–æ–∫ (%)</label>
                  <input
                    type="number"
                    step="0.1"
                    value={taxRate}
                    onChange={(e) => setTaxRate(Number(e.target.value))}
                    className="w-full bg-white/5 border border-white/20 rounded-lg px-4 py-3 text-white"
                  />
                </div>
              </div>
            </div>

            {/* –ü–µ—Ä—ñ–æ–¥ –¥–∞–Ω–∏—Ö */}
            <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
              <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
                <Calendar size={20} />
                –Ü—Å—Ç–æ—Ä–∏—á–Ω–∏–π –ø–µ—Ä—ñ–æ–¥
              </h2>
              
              <div className="space-y-4">
                <div>
                  <label className="text-sm text-gray-300 mb-2 block">–ü–æ—á–∞—Ç–∫–æ–≤–∞ –¥–∞—Ç–∞</label>
                  <input
                    type="date"
                    value={dateRange.start}
                    onChange={(e) => setDateRange({ ...dateRange, start: e.target.value })}
                    className="w-full bg-white/5 border border-white/20 rounded-lg px-4 py-3 text-white"
                  />
                </div>

                <div>
                  <label className="text-sm text-gray-300 mb-2 block">–ö—ñ–Ω—Ü–µ–≤–∞ –¥–∞—Ç–∞</label>
                  <input
                    type="date"
                    value={dateRange.end}
                    onChange={(e) => setDateRange({ ...dateRange, end: e.target.value })}
                    className="w-full bg-white/5 border border-white/20 rounded-lg px-4 py-3 text-white"
                  />
                </div>

                <div className="bg-blue-500/10 border border-blue-500/20 rounded-lg p-4">
                  <div className="flex gap-2 text-blue-300 mb-2">
                    <Info size={20} />
                    <span className="font-semibold">–ü—ñ–¥–∫–∞–∑–∫–∞</span>
                  </div>
                  <p className="text-sm text-gray-300">
                    –ë—ñ–ª—å—à–∏–π —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏–π –ø–µ—Ä—ñ–æ–¥ –¥–∞—î —Ç–æ—á–Ω—ñ—à—ñ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–Ω—ñ –æ—Ü—ñ–Ω–∫–∏ –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑—É–≤–∞–Ω–Ω—è
                  </p>
                </div>
              </div>
            </div>

            {/* –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫—É */}
            <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
              <button
                onClick={runMonteCarloSimulation}
                disabled={!isWeightValid || selectedStocks.length === 0 || loading}
                className="w-full bg-gradient-to-r from-purple-600 via-blue-600 to-pink-600 hover:from-purple-700 hover:via-blue-700 hover:to-pink-700 disabled:opacity-50 disabled:cursor-not-allowed py-4 rounded-lg font-bold text-lg flex items-center justify-center gap-3 transition-all transform hover:scale-105"
              >
                {loading ? (
                  <>
                    <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div>
                    –°–∏–º—É–ª—è—Ü—ñ—è –≤ –ø—Ä–æ—Ü–µ—Å—ñ...
                  </>
                ) : (
                  <>
                    <Zap size={24} />
                    –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Å–∏–º—É–ª—è—Ü—ñ—é
                  </>
                )}
              </button>

              {selectedStocks.length > 0 && (
                <button
                  onClick={savePortfolio}
                  className="w-full mt-4 bg-white/10 hover:bg-white/20 py-3 rounded-lg font-semibold flex items-center justify-center gap-2"
                >
                  <Save size={20} />
                  –ó–±–µ—Ä–µ–≥—Ç–∏ –ø–æ—Ä—Ç—Ñ–æ–ª—ñ–æ
                </button>
              )}
            </div>
          </div>
        )}

        {/* –ê–Ω–∞–ª—ñ–∑ */}
        {activeTab === 'analysis' && results && (
          <div className="space-y-6">
            {/* –ö–ª—é—á–æ–≤—ñ –º–µ—Ç—Ä–∏–∫–∏ */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              {[
                { 
                  label: '–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç', 
                  value: `${results.simulationStats.median.toLocaleString('uk-UA', { maximumFractionDigits: 0 })}`,
                  subtext: `+${((results.simulationStats.median / initialInvestment - 1) * 100).toFixed(1)}%`,
                  color: 'from-green-500 to-emerald-500'
                },
                { 
                  label: '–†—ñ—á–Ω–∞ –¥–æ—Ö—ñ–¥–Ω—ñ—Å—Ç—å', 
                  value: `${(results.historicalMetrics.annualReturn * 100).toFixed(2)}%`,
                  subtext: '–Ü—Å—Ç–æ—Ä–∏—á–Ω–∏–π –ø–æ–∫–∞–∑–Ω–∏–∫',
                  color: 'from-blue-500 to-cyan-500'
                },
                { 
                  label: '–í–æ–ª–∞—Ç–∏–ª—å–Ω—ñ—Å—Ç—å', 
                  value: `${(results.historicalMetrics.annualVolatility * 100).toFixed(2)}%`,
                  subtext: '–†–∏–∑–∏–∫ –ø–æ—Ä—Ç—Ñ–µ–ª—é',
                  color: 'from-orange-500 to-amber-500'
                },
                { 
                  label: '–ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –®–∞—Ä–ø–∞', 
                  value: results.historicalMetrics.sharpeRatio.toFixed(2),
                  subtext: '–î–æ—Ö—ñ–¥–Ω—ñ—Å—Ç—å/–†–∏–∑–∏–∫',
                  color: 'from-purple-500 to-pink-500'
                }
              ].map((metric, idx) => (
                <div key={idx} className="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
                  <div className="text-sm text-gray-300 mb-2">{metric.label}</div>
                  <div className={`text-3xl font-bold mb-1 bg-gradient-to-r ${metric.color} bg-clip-text text-transparent`}>
                    {metric.value}
                  </div>
                  <div className="text-xs text-gray-400">{metric.subtext}</div>
                </div>
              ))}
            </div>

            {/* –ì—Ä–∞—Ñ—ñ–∫ –ø—Ä–æ–≥–Ω–æ–∑—É */}
            <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
              <h3 className="text-2xl font-semibold mb-4">–ü—Ä–æ–≥–Ω–æ–∑ –≤–∞—Ä—Ç–æ—Å—Ç—ñ –ø–æ—Ä—Ç—Ñ–µ–ª—é</h3>
              <ResponsiveContainer width="100%" height={400}>
                <AreaChart data={results.avgPath}>
                  <defs>
                    <linearGradient id="colorP90" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="5%" stopColor="#a855f7" stopOpacity={0.3}/>
                      <stop offset="95%" stopColor="#a855f7" stopOpacity={0}/>
                    </linearGradient>
                    <linearGradient id="colorMedian" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="5%" stopColor="#22c55e" stopOpacity={0.5}/>
                      <stop offset="95%" stopColor="#22c55e" stopOpacity={0}/>
                    </linearGradient>
                  </defs>
                  <CartesianGrid strokeDasharray="3 3" stroke="#ffffff20" />
                  <XAxis dataKey="year" stroke="#fff" />
                  <YAxis stroke="#fff" />
                  <Tooltip 
                    contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #475569', borderRadius: '8px' }}
                    formatter={(value) => `${value.toLocaleString('uk-UA', { maximumFractionDigits: 0 })}`}
                  />
                  <Legend />
                  <Area type="monotone" dataKey="p90" stroke="#a855f7" fill="url(#colorP90)" fillOpacity={1} name="90-–π –ø—Ä–æ—Ü–µ–Ω—Ç—ñ–ª—å" />
                  <Area type="monotone" dataKey="median" stroke="#22c55e" fill="url(#colorMedian)" fillOpacity={1} name="–ú–µ–¥—ñ–∞–Ω–∞ (50%)" strokeWidth={3} />
                  <Line type="monotone" dataKey="p10" stroke="#ef4444" strokeWidth={2} name="10-–π –ø—Ä–æ—Ü–µ–Ω—Ç—ñ–ª—å" dot={false} />
                  <Line type="monotone" dataKey="contributions" stroke="#fbbf24" strokeWidth={2} strokeDasharray="5 5" name="–í–Ω–µ—Å–∫–∏" dot={false} />
                </AreaChart>
              </ResponsiveContainer>
            </div>

            {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å—Ü–µ–Ω–∞—Ä—ñ—ó–≤ */}
            <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
              {[
                { label: '–ü–µ—Å–∏–º—ñ—Å—Ç–∏—á–Ω–∏–π', value: results.simulationStats.p10, color: 'text-red-400', perc: 10 },
                { label: '–ù–∏–∂—á–µ —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ', value: results.simulationStats.p25, color: 'text-orange-400', perc: 25 },
                { label: '–ú–µ–¥—ñ–∞–Ω–∞', value: results.simulationStats.median, color: 'text-green-400', perc: 50 },
                { label: '–í–∏—â–µ —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ', value: results.simulationStats.p75, color: 'text-blue-400', perc: 75 },
                { label: '–û–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–∏–π', value: results.simulationStats.p90, color: 'text-purple-400', perc: 90 }
              ].map((scenario, idx) => (
                <div key={idx} className="bg-white/5 backdrop-blur-lg rounded-xl p-4 border border-white/10">
                  <div className="text-xs text-gray-400 mb-1">{scenario.label}</div>
                  <div className={`text-2xl font-bold ${scenario.color} mb-1`}>
                    ${scenario.value.toLocaleString('uk-UA', { maximumFractionDigits: 0 })}
                  </div>
                  <div className="text-xs text-gray-400">
                    {((scenario.value / initialInvestment - 1) * 100).toFixed(0)}% –ø—Ä–∏–±—É—Ç–æ–∫
                  </div>
                  <div className="text-xs text-gray-500 mt-1">
                    {scenario.perc}% –π–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å
                  </div>
                </div>
              ))}
            </div>

            {/* –†–æ–∑–ø–æ–¥—ñ–ª –∞–∫—Ü—ñ–π */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
                <h3 className="text-xl font-semibold mb-4">–†–æ–∑–ø–æ–¥—ñ–ª –ø–æ—Ä—Ç—Ñ–µ–ª—é</h3>
                <ResponsiveContainer width="100%" height={300}>
                  <PieChart>
                    <Pie
                      data={selectedStocks.map((stock, idx) => ({
                        name: stock,
                        value: weights[stock] * 100
                      }))}
                      cx="50%"
                      cy="50%"
                      labelLine={false}
                      label={({ name, value }) => `${name}: ${value.toFixed(1)}%`}
                      outerRadius={100}
                      fill="#8884d8"
                      dataKey="value"
                    >
                      {selectedStocks.map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                      ))}
                    </Pie>
                    <Tooltip />
                  </PieChart>
                </ResponsiveContainer>
              </div>

              <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
                <h3 className="text-xl font-semibold mb-4">–†–∏–∑–∏–∫-–ø—Ä–æ—Ñ—ñ–ª—å</h3>
                <div className="space-y-4">
                  <div>
                    <div className="flex justify-between text-sm mb-2">
                      <span>–ú–∞–∫—Å. –ø—Ä–æ—Å–∞–¥–∫–∞</span>
                      <span className="text-red-400 font-bold">
                        -{(results.historicalMetrics.maxDrawdown * 100).toFixed(2)}%
                      </span>
                    </div>
                    <div className="w-full bg-gray-700 rounded-full h-3">
                      <div 
                        className="bg-gradient-to-r from-red-600 to-red-400 h-3 rounded-full"
                        style={{ width: `${results.historicalMetrics.maxDrawdown * 100}%` }}
                      />
                    </div>
                  </div>

                  <div>
                    <div className="flex justify-between text-sm mb-2">
                      <span>–ô–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å –ø—Ä–∏–±—É—Ç–∫—É</span>
                      <span className="text-green-400 font-bold">
                        {(results.simulationStats.positiveYears * 100).toFixed(1)}%
                      </span>
                    </div>
                    <div className="w-full bg-gray-700 rounded-full h-3">
                      <div 
                        className="bg-gradient-to-r from-green-600 to-green-400 h-3 rounded-full"
                        style={{ width: `${results.simulationStats.positiveYears * 100}%` }}
                      />
                    </div>
                  </div>

                  <div>
                    <div className="flex justify-between text-sm mb-2">
                      <span>–£—Å–ø—ñ—à–Ω—ñ—Å—Ç—å (–ø–æ–¥–≤–æ—î–Ω–Ω—è)</span>
                      <span className="text-purple-400 font-bold">
                        {(results.simulationStats.successRate * 100).toFixed(1)}%
                      </span>
                    </div>
                    <div className="w-full bg-gray-700 rounded-full h-3">
                      <div 
                        className="bg-gradient-to-r from-purple-600 to-purple-400 h-3 rounded-full"
                        style={{ width: `${results.simulationStats.successRate * 100}%` }}
                      />
                    </div>
                  </div>

                  <div className="bg-blue-500/10 border border-blue-500/20 rounded-lg p-4 mt-4">
                    <div className="text-sm">
                      <div className="font-semibold text-blue-300 mb-2">VaR (95%)</div>
                      <div className="text-gray-300">
                        –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π –æ—á—ñ–∫—É–≤–∞–Ω–∏–π –∑–±–∏—Ç–æ–∫: <span className="text-red-400 font-bold">
                          {(results.historicalMetrics.var95 * 100).toFixed(2)}%
                        </span> –∑ –π–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—é 5%
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* –î–µ—Ç–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è */}
            <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
              <h3 className="text-xl font-semibold mb-4">–§—ñ–Ω–∞–Ω—Å–æ–≤–∞ –ø—Ä–æ—î–∫—Ü—ñ—è —á–µ—Ä–µ–∑ {forecastYears} —Ä–æ–∫—ñ–≤</h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="bg-gradient-to-br from-green-500/20 to-green-600/10 rounded-lg p-6 border border-green-500/30">
                  <div className="text-sm text-green-300 mb-2">–ó–∞–≥–∞–ª—å–Ω—ñ –≤–Ω–µ—Å–∫–∏</div>
                  <div className="text-3xl font-bold text-green-400">
                    ${results.avgPath[forecastYears].contributions.toLocaleString('uk-UA', { maximumFractionDigits: 0 })}
                  </div>
                </div>

                <div className="bg-gradient-to-br from-blue-500/20 to-blue-600/10 rounded-lg p-6 border border-blue-500/30">
                  <div className="text-sm text-blue-300 mb-2">–û—á—ñ–∫—É–≤–∞–Ω–∏–π –ø—Ä–∏–±—É—Ç–æ–∫</div>
                  <div className="text-3xl font-bold text-blue-400">
                    ${results.avgPath[forecastYears].gains.toLocaleString('uk-UA', { maximumFractionDigits: 0 })}
                  </div>
                </div>

                <div className="bg-gradient-to-br from-purple-500/20 to-purple-600/10 rounded-lg p-6 border border-purple-500/30">
                  <div className="text-sm text-purple-300 mb-2">–ó–∞–≥–∞–ª—å–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å</div>
                  <div className="text-3xl font-bold text-purple-400">
                    ${results.avgPath[forecastYears].median.toLocaleString('uk-UA', { maximumFractionDigits: 0 })}
                  </div>
                </div>
              </div>

              <div className="mt-6 bg-amber-500/10 border border-amber-500/20 rounded-lg p-4">
                <div className="flex gap-2 text-amber-300 mb-2">
                  <Target size={20} />
                  <span className="font-semibold">–Ü–Ω—Å–∞–π—Ç–∏</span>
                </div>
                <ul className="text-sm text-gray-300 space-y-2">
                  <li>‚Ä¢ –ó –π–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—é 50% –≤–∞—à –ø–æ—Ä—Ç—Ñ–µ–ª—å –¥–æ—Å—è–≥–Ω–µ ${results.simulationStats.median.toLocaleString('uk-UA', { maximumFractionDigits: 0 })}</li>
                  <li>‚Ä¢ –£ –Ω–∞–π–≥—ñ—Ä—à–æ–º—É —Å—Ü–µ–Ω–∞—Ä—ñ—ó (10%) –æ—á—ñ–∫—É—î—Ç—å—Å—è ${results.simulationStats.p10.toLocaleString('uk-UA', { maximumFractionDigits: 0 })}</li>
                  <li>‚Ä¢ –£ –Ω–∞–π–∫—Ä–∞—â–æ–º—É —Å—Ü–µ–Ω–∞—Ä—ñ—ó (90%) –º–æ–∂–ª–∏–≤–æ ${results.simulationStats.p90.toLocaleString('uk-UA', { maximumFractionDigits: 0 })}</li>
                  <li>‚Ä¢ –°–µ—Ä–µ–¥–Ω—è —Ä—ñ—á–Ω–∞ –¥–æ—Ö—ñ–¥–Ω—ñ—Å—Ç—å: {(results.simulationStats.avgAnnualReturn * 100).toFixed(2)}%</li>
                </ul>
              </div>
            </div>
          </div>
        )}

        {/* –ó–±–µ—Ä–µ–∂–µ–Ω—ñ –ø–æ—Ä—Ç—Ñ–æ–ª—ñ–æ */}
        {activeTab === 'saved' && (
          <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
            <h2 className="text-2xl font-semibold mb-6">–ó–±–µ—Ä–µ–∂–µ–Ω—ñ –ø–æ—Ä—Ç—Ñ–æ–ª—ñ–æ</h2>
            
            {savedPortfolios.length === 0 ? (
              <div className="text-center py-12 text-gray-400">
                <FolderOpen size={64} className="mx-auto mb-4 opacity-50" />
                <p>–ù–µ–º–∞—î –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö –ø–æ—Ä—Ç—Ñ–æ–ª—ñ–æ</p>
                <p className="text-sm mt-2">–°—Ç–≤–æ—Ä—ñ—Ç—å —Ç–∞ –∑–±–µ—Ä–µ–∂—ñ—Ç—å —Å–≤—ñ–π –ø–µ—Ä—à–∏–π –ø–æ—Ä—Ç—Ñ–µ–ª—å!</p>
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {savedPortfolios.map((portfolio, idx) => (
                  <div 
                    key={idx} 
                    className="bg-white/5 rounded-lg p-6 border border-white/10 hover:border-purple-500/50 transition-all cursor-pointer"
                    onClick={() => loadPortfolio(portfolio)}
                  >
                    <div className="flex justify-between items-start mb-4">
                      <h3 className="text-lg font-semibold">{portfolio.name}</h3>
                      <span className="text-xs text-gray-400">
                        {new Date(portfolio.timestamp).toLocaleDateString('uk-UA')}
                      </span>
                    </div>
                    
                    <div className="space-y-2 text-sm">
                      <div className="flex justify-between">
                        <span className="text-gray-400">–ê–∫—Ü—ñ—ó:</span>
                        <span className="font-mono">{portfolio.stocks.join(', ')}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-400">–ü–æ—á–∞—Ç–∫–æ–≤–∞ —ñ–Ω–≤–µ—Å—Ç–∏—Ü—ñ—è:</span>
                        <span className="text-green-400">${portfolio.settings.initialInvestment.toLocaleString()}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-400">–ì–æ—Ä–∏–∑–æ–Ω—Ç:</span>
                        <span>{portfolio.settings.forecastYears} —Ä–æ–∫—ñ–≤</span>
                      </div>
                    </div>

                    <button className="w-full mt-4 bg-purple-600 hover:bg-purple-700 py-2 rounded-lg text-sm font-semibold transition-all">
                      –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–æ—Ä—Ç—Ñ–æ–ª—ñ–æ
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  );
};

export default PortfolioAnalyzer;